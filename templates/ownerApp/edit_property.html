{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Property - PS6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            light: '#f8fafc',
                            accent: '#334155'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step.active .step-icon {
            background-color: #000;
            color: #fff;
            border-color: #000;
        }

        .step.active .step-label {
            color: #000;
            font-weight: 600;
        }

        .form-section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .form-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Leaflet Map Customization */
        .leaflet-container {
            border-radius: 1rem;
            z-index: 0;
        }
    </style>
</head>

<body class="font-sans bg-gray-50 text-brand-dark antialiased min-h-screen flex flex-col">

    {% include 'Navbar/ownerNavBar.html' %}

    <main class="flex-grow container mx-auto px-4 py-24 max-w-7xl">

        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Sidebar / Progress -->
            <div class="lg:w-1/4">
                <div class="glass-card rounded-[2rem] p-6 sticky top-24">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold mb-2">Edit Property</h1>
                        <p class="text-gray-500 text-sm">Update property details</p>
                    </div>

                    <div class="space-y-6 relative">
                        <!-- Connecting Line -->
                        <div class="absolute left-4 top-4 bottom-4 w-0.5 bg-gray-100 -z-10"></div>

                        <!-- Steps -->
                        <div class="step active flex items-center gap-4 cursor-pointer" onclick="goToStep(0)">
                            <div
                                class="step-icon w-8 h-8 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center text-gray-400 transition-colors z-10">
                                <i class="fas fa-info text-xs"></i>
                            </div>
                            <span class="step-label text-gray-500 transition-colors">Basic Info</span>
                        </div>
                        <div class="step flex items-center gap-4 cursor-pointer" onclick="goToStep(1)">
                            <div
                                class="step-icon w-8 h-8 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center text-gray-400 transition-colors z-10">
                                <i class="fas fa-map-marker-alt text-xs"></i>
                            </div>
                            <span class="step-label text-gray-500 transition-colors">Location</span>
                        </div>
                        <div class="step flex items-center gap-4 cursor-pointer" onclick="goToStep(2)">
                            <div
                                class="step-icon w-8 h-8 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center text-gray-400 transition-colors z-10">
                                <i class="fas fa-images text-xs"></i>
                            </div>
                            <span class="step-label text-gray-500 transition-colors">Images</span>
                        </div>
                        <div class="step flex items-center gap-4 cursor-pointer" onclick="goToStep(3)">
                            <div
                                class="step-icon w-8 h-8 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center text-gray-400 transition-colors z-10">
                                <i class="fas fa-list text-xs"></i>
                            </div>
                            <span class="step-label text-gray-500 transition-colors">Details</span>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-gray-100">
                        <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
                            <i class="fas fa-lightbulb text-yellow-500"></i> Editing Tips
                        </h4>
                        <ul class="text-xs text-gray-500 space-y-2 list-disc pl-4">
                            <li>Keep information up to date</li>
                            <li>Refresh images periodically</li>
                            <li>Check location accuracy</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Main Form Area -->
            <div class="lg:w-3/4">
                <form method="POST" enctype="multipart/form-data" class="glass-card rounded-[2rem] p-8 shadow-xl"
                    id="uploadForm">
                    {% csrf_token %}

                    <!-- Step 1: Basic Info -->
                    <div class="form-section active" id="step-0">
                        <h2 class="text-2xl font-bold mb-6">Basic Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Property Title</label>
                                {{ form.title }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Property Type</label>
                                {{ form.property_type }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Price (₹)</label>
                                {{ form.price }}
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Overview (Short
                                    Description)</label>
                                {{ form.overview }}
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Full Description</label>
                                {{ form.description }}
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Location -->
                    <div class="form-section" id="step-1">
                        <h2 class="text-2xl font-bold mb-6">Location Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Location/Area</label>
                                {{ form.location }}
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Full Address</label>
                                {{ form.address }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                                {{ form.state }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pincode</label>
                                {{ form.pincode }}
                            </div>

                            <!-- Map Integration -->
                            <div class="col-span-2 mt-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-medium text-gray-700">Pin Location on Map</label>
                                    <button type="button" onclick="useCurrentLocation()"
                                        class="text-xs bg-black text-white px-3 py-1 rounded-full hover:bg-gray-800 transition">
                                        <i class="fas fa-crosshairs mr-1"></i> Use Current Location
                                    </button>
                                </div>
                                <div id="map" class="h-64 w-full rounded-xl border border-gray-200"></div>
                                <div class="mt-2 text-xs text-gray-500 flex justify-between">
                                    <span>Drag marker to exact location</span>
                                    <a href="#" id="location-preview-link" target="_blank"
                                        class="text-blue-500 hover:underline">View on OpenStreetMap</a>
                                </div>
                                {{ form.location_url }} <!-- Hidden field usually -->
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Images -->
                    <div class="form-section" id="step-2">
                        <h2 class="text-2xl font-bold mb-6">Property Images</h2>
                        <div class="space-y-6">
                            <!-- Main Image -->
                            <div class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-black transition cursor-pointer"
                                onclick="document.getElementById('id_image').click()">
                                <div id="preview-image"
                                    class="h-48 w-full bg-gray-50 rounded-xl mb-4 bg-cover bg-center {% if not property.image %}hidden{% endif %}"
                                    {% if property.image %}style="background-image: url('{{ property.image.url }}')" {%
                                    endif %}></div>
                                <div id="upload-placeholder-image" class="{% if property.image %}hidden{% endif %}">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-300 mb-3"></i>
                                    <p class="font-medium text-gray-900">Click to replace Main Image</p>
                                    <p class="text-sm text-gray-500">SVG, PNG, JPG or GIF (MAX. 800x400px)</p>
                                </div>
                                {{ form.image }}
                            </div>

                            <div class="grid grid-cols-2 gap-6">
                                <!-- Image 2 -->
                                <div class="border-2 border-dashed border-gray-300 rounded-2xl p-6 text-center hover:border-black transition cursor-pointer"
                                    onclick="document.getElementById('id_image_2').click()">
                                    <div id="preview-image_2"
                                        class="h-32 w-full bg-gray-50 rounded-xl mb-2 bg-cover bg-center {% if not property.image_2 %}hidden{% endif %}"
                                        {% if property.image_2
                                        %}style="background-image: url('{{ property.image_2.url }}')" {% endif %}></div>
                                    <div id="upload-placeholder-image_2"
                                        class="{% if property.image_2 %}hidden{% endif %}">
                                        <i class="fas fa-image text-2xl text-gray-300 mb-2"></i>
                                        <p class="text-sm font-medium">Additional Image 1</p>
                                    </div>
                                    {{ form.image_2 }}
                                </div>
                                <!-- Image 3 -->
                                <div class="border-2 border-dashed border-gray-300 rounded-2xl p-6 text-center hover:border-black transition cursor-pointer"
                                    onclick="document.getElementById('id_image_3').click()">
                                    <div id="preview-image_3"
                                        class="h-32 w-full bg-gray-50 rounded-xl mb-2 bg-cover bg-center {% if not property.image_3 %}hidden{% endif %}"
                                        {% if property.image_3
                                        %}style="background-image: url('{{ property.image_3.url }}')" {% endif %}></div>
                                    <div id="upload-placeholder-image_3"
                                        class="{% if property.image_3 %}hidden{% endif %}">
                                        <i class="fas fa-image text-2xl text-gray-300 mb-2"></i>
                                        <p class="text-sm font-medium">Additional Image 2</p>
                                    </div>
                                    {{ form.image_3 }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Details -->
                    <div class="form-section" id="step-3">
                        <h2 class="text-2xl font-bold mb-6">Additional Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bedrooms</label>
                                {{ form.bedrooms }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bathrooms</label>
                                {{ form.bathrooms }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Size (sq ft)</label>
                                {{ form.size }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Parking</label>
                                {{ form.parking }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Year Built</label>
                                {{ form.year_built }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Flooring</label>
                                {{ form.flooring_type }}
                            </div>

                            <div class="col-span-full border-t border-gray-100 pt-6 mt-2">
                                <h3 class="font-bold mb-4">Contact & Status</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Owner Name</label>
                                        {{ form.owner_name }}
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                        {{ form.email }}
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                        {{ form.phone }}
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Occupancy
                                            Status</label>
                                        {{ form.occupancy_status }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="flex justify-between mt-8 pt-6 border-t border-gray-100">
                        <button type="button" id="prevBtn"
                            class="px-6 py-3 rounded-xl font-medium text-gray-600 hover:bg-gray-100 transition hidden"
                            onclick="changeStep(-1)">
                            Back
                        </button>
                        <div class="flex-grow"></div>
                        <button type="button" id="nextBtn"
                            class="px-8 py-3 rounded-full font-bold bg-black text-white hover:bg-gray-800 transition shadow-lg"
                            onclick="changeStep(1)">
                            Next Step <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                        <button type="submit" id="submitBtn"
                            class="px-8 py-3 rounded-full font-bold bg-blue-600 text-white hover:bg-blue-700 transition shadow-lg hidden">
                            Update Property <i class="fas fa-check ml-2"></i>
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </main>

    <script>
        // Apply Tailwind classes to Django form fields
        document.addEventListener('DOMContentLoaded', function () {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type !== 'hidden' && input.type !== 'file' && input.type !== 'checkbox') {
                    input.classList.add('w-full', 'px-4', 'py-3', 'rounded-xl', 'bg-gray-50', 'border-transparent', 'focus:bg-white', 'focus:border-black', 'focus:ring-0', 'transition');
                }
            });

            // File inputs are hidden, so we don't style them directly
            ['id_image', 'id_image_2', 'id_image_3'].forEach(id => {
                const input = document.getElementById(id);
                if (input) input.classList.add('hidden');
            });
        });

        // Multi-step Logic
        let currentStep = 0;
        const steps = document.querySelectorAll('.step');
        const sections = document.querySelectorAll('.form-section');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        function showStep(n) {
            sections.forEach((s, i) => {
                s.classList.remove('active');
                if (i === n) s.classList.add('active');
            });

            steps.forEach((s, i) => {
                s.classList.remove('active');
                if (i === n) s.classList.add('active');
            });

            prevBtn.classList.toggle('hidden', n === 0);

            if (n === sections.length - 1) {
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
            }

            // Refresh map if on location step
            if (n === 1 && map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        function changeStep(n) {
            if (n === 1 && !validateCurrentStep()) return;
            currentStep += n;
            showStep(currentStep);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToStep(n) {
            if (n > currentStep && !validateCurrentStep()) return;
            currentStep = n;
            showStep(currentStep);
        }

        function validateCurrentStep() {
            const currentSection = sections[currentStep];
            const inputs = currentSection.querySelectorAll('input[required], select[required], textarea[required]');
            let valid = true;
            inputs.forEach(input => {
                if (!input.value) {
                    input.classList.add('border-red-500', 'bg-red-50');
                    valid = false;
                } else {
                    input.classList.remove('border-red-500', 'bg-red-50');
                }
            });
            if (!valid) alert('Please fill in all required fields.');
            return valid;
        }

        // Map Logic
        let map, marker;
        function initMap() {
            // Default to India center if no location provided
            let initialLat = 20.5937;
            let initialLng = 78.9629;
            let initialZoom = 5;

            // Try to parse existing location URL if available
            const locationUrl = document.getElementById('id_location_url').value;
            if (locationUrl) {
                const match = locationUrl.match(/mlat=([\d.-]+)&mlon=([\d.-]+)/);
                if (match) {
                    initialLat = parseFloat(match[1]);
                    initialLng = parseFloat(match[2]);
                    initialZoom = 16;
                }
            }

            map = L.map('map').setView([initialLat, initialLng], initialZoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);

            marker = L.marker([initialLat, initialLng], { draggable: true }).addTo(map);

            marker.on('dragend', function (e) {
                const pos = marker.getLatLng();
                updateLocation(pos.lat, pos.lng);
            });

            map.on('click', function (e) {
                marker.setLatLng(e.latlng);
                updateLocation(e.latlng.lat, e.latlng.lng);
            });

            // Set initial preview link
            if (locationUrl) {
                document.getElementById('location-preview-link').href = locationUrl;
            }
        }

        function updateLocation(lat, lng) {
            const url = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=16/${lat}/${lng}`;
            document.getElementById('id_location_url').value = url;
            document.getElementById('location-preview-link').href = url;

            // Reverse Geocoding (Optional enhancement)
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
                .then(res => res.json())
                .then(data => {
                    if (data.address) {
                        if (document.getElementById('id_address')) document.getElementById('id_address').value = data.display_name;
                        if (document.getElementById('id_pincode')) document.getElementById('id_pincode').value = data.address.postcode || '';
                        if (document.getElementById('id_state')) document.getElementById('id_state').value = data.address.state || '';
                        if (document.getElementById('id_location')) document.getElementById('id_location').value = data.address.city || data.address.town || '';
                    }
                });
        }

        function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    map.setView([latitude, longitude], 16);
                    marker.setLatLng([latitude, longitude]);
                    updateLocation(latitude, longitude);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Image Previews
        function setupImagePreview(inputId, previewId, placeholderId) {
            document.getElementById(inputId).addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const preview = document.getElementById(previewId);
                        const placeholder = document.getElementById(placeholderId);
                        preview.style.backgroundImage = `url(${e.target.result})`;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        setupImagePreview('id_image', 'preview-image', 'upload-placeholder-image');
        setupImagePreview('id_image_2', 'preview-image_2', 'upload-placeholder-image_2');
        setupImagePreview('id_image_3', 'preview-image_3', 'upload-placeholder-image_3');

        // Init
        initMap();
    </script>
</body>

</html>